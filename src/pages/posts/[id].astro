---
import Layout from '../../layouts/single-column.astro'
import { getEnv } from '../../lib/env'
import voidFile from '../../assets/void.png'
import { getChannelInfo } from '../../lib/telegram'
import dayjs from '../../lib/dayjs'

const { SITE_URL } = Astro.locals
const locale = getEnv(import.meta.env, Astro, 'LOCALE')
const timezone = getEnv(import.meta.env, Astro, 'TIMEZONE')
const COMMENTS = getEnv(import.meta.env, Astro, 'COMMENTS')

// è·å–æ¥æºé¡µé¢ä¿¡æ¯ï¼Œç”¨äºé¢åŒ…å±‘å¯¼èˆªå’Œè¿”å›é“¾æ¥
const referer = Astro.request.headers.get('referer')
let sourcePage = '/'
let sourceText = 'é¦–é¡µ'
let showMiddleBreadcrumb = true // æ§åˆ¶æ˜¯å¦æ˜¾ç¤ºä¸­é—´çš„é¢åŒ…å±‘å±‚çº§

if (referer) {
  const url = new URL(referer)
  const pathname = url.pathname

  if (pathname === '/posts' || pathname.startsWith('/posts/')) {
    sourcePage = '/posts'
    sourceText = 'æ–‡ç« '
  } else if (pathname.startsWith('/before/')) {
    sourcePage = pathname
    sourceText = 'æ–‡ç« åˆ—è¡¨'
  } else if (pathname === '/search/' || pathname.startsWith('/search/')) {
    sourcePage = '/search'
    sourceText = 'æœç´¢'
  } else if (pathname === '/' || pathname === '') {
    // ä»é¦–é¡µè¿›å…¥æ—¶ï¼Œä¸éœ€è¦æ˜¾ç¤ºä¸­é—´çš„é¢åŒ…å±‘å±‚çº§
    showMiddleBreadcrumb = false
  }
}

locale && dayjs.locale(locale)

const channelInfo = await getChannelInfo(Astro)

const post = await getChannelInfo(Astro, {
  type: 'post',
  id: Astro.params.id,
})

// æå–æ ‡é¢˜ - æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ä»¥@å¼€å¤´
function extractTitle(content) {
  // è·å–çº¯æ–‡æœ¬å†…å®¹ï¼ŒåŒæ—¶ä¿ç•™æ¢è¡Œç¬¦ä»¥ä¾¿æ­£ç¡®åˆ†å‰²
  let plainText = content
    .replace(/<br\s*\/?\s*>/gi, '\n') // å°†<br>æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦
    .replace(/<\/p>/gi, '\n') // å°†</p>æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦
    .replace(/<[^>]*>/g, '') // ç§»é™¤å…¶ä»–HTMLæ ‡ç­¾
    .replace(/&nbsp;/g, ' '); // å°†&nbsp;è½¬æ¢ä¸ºç©ºæ ¼

  // æŒ‰è¡Œåˆ†å‰²
  const lines = plainText.split('\n').filter(line => line.trim());

  // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ä»¥@å¼€å¤´
  if (lines.length > 0 && lines[0].trim().startsWith('@')) {
    const firstLine = lines[0].trim();
    // è¿”å›ç¬¬ä¸€ä¸ª@åçš„æ‰€æœ‰å†…å®¹ï¼ˆä¸åŒ…æ‹¬ç¬¬ä¸€ä¸ª@ï¼‰
    return firstLine.substring(1).trim();
  }

  return null; // æ²¡æœ‰æ ‡é¢˜
}

// ç§»é™¤ç¬¬ä¸€è¡Œæ ‡é¢˜ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
function removeTitleFromContent(content) {
  // æ£€æŸ¥æ˜¯å¦æœ‰@å¼€å¤´çš„æ ‡é¢˜
  let plainText = content
    .replace(/<br\s*\/?\s*>/gi, '\n') // å°†<br>æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦
    .replace(/<\/p>/gi, '\n') // å°†</p>æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦
    .replace(/<[^>]*>/g, '') // ç§»é™¤å…¶ä»–HTMLæ ‡ç­¾
    .replace(/&nbsp;/g, ' '); // å°†&nbsp;è½¬æ¢ä¸ºç©ºæ ¼

  const lines = plainText.split('\n').filter(line => line.trim());

  // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ä»¥@å¼€å¤´
  if (lines.length > 0 && lines[0].trim().startsWith('@')) {
    // éœ€è¦ç§»é™¤åŸå§‹HTMLä¸­çš„ç¬¬ä¸€è¡Œ
    // å¤„ç†å‡ ç§æƒ…å†µ:
    // 1. <p>@æ ‡é¢˜</p>
    // 2. @æ ‡é¢˜<br/>
    // 3. @æ ‡é¢˜\n

    const titlePattern = /(<p[^>]*>)?\s*@\s*[^\n<]*(<\/p>)?(<br\s*\/?\s*>|\n)?/i;

    // ç§»é™¤åŒ…å«@å¼€å¤´çš„æ ‡é¢˜è¡ŒåŠå…¶åçš„æ¢è¡Œç¬¦æˆ–<br>æ ‡ç­¾
    let processedContent = content.replace(titlePattern, '');

    // å¦‚æœç¬¬ä¸€ä¸ªæ¨¡å¼æ²¡æœ‰åŒ¹é…ï¼Œå°è¯•æ›´å®½æ¾çš„æ¨¡å¼
    if (processedContent === content) {
      // å°è¯•åŒ¹é…ä»»ä½•åŒ…å«@çš„å†…å®¹ï¼Œç›´åˆ°é‡åˆ°<br>æˆ–æ¢è¡Œ
      const fallbackPattern = /@[^<\n]*/i;
      processedContent = content.replace(fallbackPattern, '');
    }

    // ç§»é™¤å¯èƒ½ç•™ä¸‹çš„ç©ºç™½è¡Œ
    processedContent = processedContent.replace(/^(\s*<br\s*\/?\s*>\s*)+/, '');

    return processedContent;
  }

  return content; // æ²¡æœ‰æ ‡é¢˜ï¼Œè¿”å›åŸå†…å®¹
}

const postTitle = extractTitle(post.content || '') || 'æ— æ ‡é¢˜';

// æå–æ ‡ç­¾ - æ£€æŸ¥æœ€åä¸€è¡Œæ˜¯å¦æœ‰#å¼€å¤´çš„æ ‡ç­¾
function extractTags(content) {
  // è·å–çº¯æ–‡æœ¬å†…å®¹ï¼ŒåŒæ—¶ä¿ç•™æ¢è¡Œç¬¦ä»¥ä¾¿æ­£ç¡®åˆ†å‰²
  let plainText = content
    .replace(/<br\s*\/\s*>/gi, '\n') // å°†<br>æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦
    .replace(/<\/p>/gi, '\n') // å°†</p>æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦
    .replace(/<[^>]*>/g, '') // ç§»é™¤å…¶ä»–HTMLæ ‡ç­¾
    .replace(/&nbsp;/g, ' '); // å°†&nbsp;è½¬æ¢ä¸ºç©ºæ ¼

  // æŒ‰è¡Œåˆ†å‰²å¹¶è¿‡æ»¤ç©ºè¡Œ
  const lines = plainText.split('\n').filter(line => line.trim());

  // æ£€æŸ¥æœ€åä¸€è¡Œæ˜¯å¦åŒ…å«#å¼€å¤´çš„æ ‡ç­¾
  if (lines.length > 0) {
    const lastLine = lines[lines.length - 1].trim();
    // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ‰€æœ‰#å¼€å¤´çš„æ ‡ç­¾
    const tagMatches = lastLine.match(/#([^\s#]+)/g);

    if (tagMatches && tagMatches.length > 0) {
      // ç§»é™¤#ç¬¦å·ï¼Œåªä¿ç•™æ ‡ç­¾å
      return tagMatches.map(tag => tag.substring(1));
    }
  }

  return []; // æ²¡æœ‰æ ‡ç­¾
}

// ç§»é™¤æœ€åä¸€è¡Œæ ‡ç­¾ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
function removeTagsFromContent(content) {
  // æ£€æŸ¥æ˜¯å¦æœ‰#å¼€å¤´çš„æ ‡ç­¾è¡Œ
  let plainText = content
    .replace(/<br\s*\/\s*>/gi, '\n') // å°†<br>æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦
    .replace(/<\/p>/gi, '\n') // å°†</p>æ ‡ç­¾è½¬æ¢ä¸ºæ¢è¡Œç¬¦
    .replace(/<[^>]*>/g, '') // ç§»é™¤å…¶ä»–HTMLæ ‡ç­¾
    .replace(/&nbsp;/g, ' '); // å°†&nbsp;è½¬æ¢ä¸ºç©ºæ ¼

  const lines = plainText.split('\n').filter(line => line.trim());

  // æ£€æŸ¥æœ€åä¸€è¡Œæ˜¯å¦åŒ…å«#å¼€å¤´çš„æ ‡ç­¾
  if (lines.length > 0) {
    const lastLine = lines[lines.length - 1].trim();
    const tagMatches = lastLine.match(/#([^\s#]+)/g);

    if (tagMatches && tagMatches.length > 0) {
      // éœ€è¦ç§»é™¤åŸå§‹HTMLä¸­çš„æœ€åä¸€è¡Œ
      // å¤„ç†å‡ ç§æƒ…å†µ:
      // 1. <p>#æ ‡ç­¾1 #æ ‡ç­¾2</p>
      // 2. #æ ‡ç­¾1 #æ ‡ç­¾2<br/>
      // 3. #æ ‡ç­¾1 #æ ‡ç­¾2\n

      const tagPattern = /(<p[^>]*>)?\s*#([^\s<#]+)(\s*#([^\s<#]+))*(<\/p>)?(<br\s*\/\s*>|\n)?$/i;

      // ç§»é™¤åŒ…å«#å¼€å¤´çš„æ ‡ç­¾è¡ŒåŠå…¶åçš„æ¢è¡Œç¬¦æˆ–<br>æ ‡ç­¾
      let processedContent = content.replace(tagPattern, '');

      // å¦‚æœç¬¬ä¸€ä¸ªæ¨¡å¼æ²¡æœ‰åŒ¹é…ï¼Œå°è¯•æ›´å®½æ¾çš„æ¨¡å¼
      if (processedContent === content) {
        // å°è¯•åŒ¹é…ä»»ä½•åŒ…å«#çš„å†…å®¹ï¼Œç›´åˆ°é‡åˆ°<br>æˆ–æ¢è¡Œ
        const fallbackPattern = /#[^<\n]*$/i;
        processedContent = content.replace(fallbackPattern, '');
      }

      // ç§»é™¤å¯èƒ½ç•™ä¸‹çš„ç©ºç™½è¡Œ
      processedContent = processedContent.replace(/(\s*<br\s*\/\s*>\s*)+$/, '');

      return processedContent;
    }
  }

  return content; // æ²¡æœ‰æ ‡ç­¾ï¼Œè¿”å›åŸå†…å®¹
}

const postTags = extractTags(post.content || '');

// å¤„ç†å†…å®¹ - ç§»é™¤æ ‡é¢˜è¡Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰å’Œæ ‡ç­¾è¡Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
const contentWithoutTitle = removeTitleFromContent(post.content || '');
const processedContent = removeTagsFromContent(contentWithoutTitle);

// å¤„ç†é“¾æ¥å†…å®¹ï¼Œå°†å…¶è½¬æ¢ä¸ºå¸¦å›¾æ ‡ã€æ ‡é¢˜å’ŒåŸŸåçš„å—çŠ¶æ ·å¼
function processLinks(content) {
  if (!content) return content;

  // é¦–å…ˆæå–æ‰€æœ‰Telegramé¢„è§ˆå¡ç‰‡çš„ä¿¡æ¯
  const previewMap = new Map();

  // åŒ¹é…æ‰€æœ‰Telegramé¢„è§ˆé“¾æ¥å¹¶æå–ä¿¡æ¯
  content.replace(/<a\s+[^>]*class="[^"]*tgme_widget_message_link_preview[^"]*"[^>]*href="([^"]*)"[^>]*>(.*?)<\/a>/gis, (match, href, innerContent) => {
    const titleMatch = innerContent.match(/<div\s+class="link_preview_title"[^>]*>([^<]*)<\/div>/i);
    const title = titleMatch ? titleMatch[1].trim() : null;

    const descriptionMatch = innerContent.match(/<div\s+class="link_preview_description"[^>]*>([^<]*)<\/div>/i);
    const description = descriptionMatch ? descriptionMatch[1].trim() : null;

    if (title) {
      previewMap.set(href, { title, description });
    }
    return '';
  });

  // å¤„ç†æ‰€æœ‰æ™®é€šé“¾æ¥ï¼Œç§»é™¤åŸæœ‰çš„æ™®é€šé“¾æ¥ï¼Œå¦‚æœå­˜åœ¨å¯¹åº”çš„é¢„è§ˆå¡ç‰‡ä¿¡æ¯
  let result = content.replace(/<a\s+([^>]*?)>([^<]*?)<\/a>/gi, (match, attrs, text) => {
    // è·³è¿‡ç‰¹å®šç±»åˆ«çš„é“¾æ¥å’Œå·²å¤„ç†çš„é“¾æ¥
    if (attrs.includes('class="tag"') ||
        attrs.includes('class="breadcrumb-link"') ||
        attrs.includes('class="back-button"') ||
        attrs.includes('link-preview-card') ||
        attrs.includes('tgme_widget_message_link_preview')) {
      return match;
    }

    // è·³è¿‡é‚®ä»¶å’Œç”µè¯é“¾æ¥
    if (attrs.includes('mailto:') || attrs.includes('tel:')) {
      return match;
    }

    // æå–hrefå±æ€§
    const hrefMatch = attrs.match(/href="([^"]*)"/i);
    if (!hrefMatch) return match;

    const href = hrefMatch[1];

    // è·³è¿‡é”šç‚¹ã€ç›¸å¯¹é“¾æ¥å’Œæœç´¢é“¾æ¥
    if (href.startsWith('#') || href.startsWith('/') || href.includes('search/') || href.startsWith('mailto:') || href.startsWith('tel:')) {
      return match;
    }

    try {
      // ä½¿ç”¨é¢„è§ˆå¡ç‰‡ä¸­çš„æ ‡é¢˜å’Œæè¿°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é“¾æ¥æ–‡æœ¬
      const previewData = previewMap.get(href);
      const title = previewData ? previewData.title : text || '';
      const description = previewData ? previewData.description : href;

      const url = new URL(href);
      const domain = url.hostname.replace('www.', '');

      // æ ¹æ®åŸŸåç”Ÿæˆå›¾æ ‡
      let icon = domain.charAt(0).toUpperCase();
      const iconMap = {
        'github.com': 'âš¡',
        'youtube.com': 'â–¶',
        'twitter.com': 'ğŸ¦',
        'x.com': 'ğ•',
        'linkedin.com': 'ğŸ’¼',
        'stackoverflow.com': 'ğŸ“š',
        'medium.com': 'ğŸ“',
        'reddit.com': 'ğŸ¤–',
        'wikipedia.org': 'ğŸ“–',
        'google.com': 'ğŸ”',
        'apple.com': 'ğŸ',
        'microsoft.com': 'âŠ',
        'amazon.com': 'ğŸ“¦',
        'netflix.com': 'ğŸ¬',
        'spotify.com': 'ğŸµ',
        'instagram.com': 'ğŸ“·',
        'facebook.com': 'ğŸ“˜',
        'telegram.org': 'âœˆï¸',
        'discord.com': 'ğŸ’¬',
        'notion.so': 'ğŸ“‹',
        'figma.com': 'ğŸ¨',
        'dribbble.com': 'ğŸ€',
        'behance.net': 'ğŸª',
        'codepen.io': 'ğŸ–Šï¸',
        'jsfiddle.net': 'ğŸ”§',
        'codesandbox.io': 'ğŸ–ï¸',
        'vercel.com': 'â–²',
        'netlify.app': 'â–²',
        'music.163.com': 'ğŸµ',
      };

      // æ£€æŸ¥åŸŸåæ˜¯å¦åœ¨å›¾æ ‡æ˜ å°„ä¸­
      for (const [key, mappedIcon] of Object.entries(iconMap)) {
        if (domain.includes(key)) {
          icon = mappedIcon;
          break;
        }
      }

      // æ„å»ºæ–°çš„é“¾æ¥HTMLç»“æ„
      const newAttrs = attrs.replace(/style="[^"]*"/gi, '');
      return `
        <a href="${href}" ${newAttrs} class="link-preview-wrapper" style="border-bottom: none; padding-bottom: 0;">
          <div class="link-preview-card">
            <div class="link-preview-header">
              <div class="link-preview-icon">${icon}</div>
              <div class="link-preview-title">${title}</div>
            </div>
            <div class="link-preview-domain">${description}</div>
          </div>
        </a>
      `.trim();
    } catch (e) {
      // å¦‚æœURLè§£æå¤±è´¥ï¼Œè¿”å›åŸé“¾æ¥
      return match;
    }
  });

  // æœ€åç§»é™¤æ‰€æœ‰Telegramé¢„è§ˆé“¾æ¥
  result = result.replace(/<a\s+[^>]*class="[^"]*tgme_widget_message_link_preview[^"]*"[^>]*>.*?<\/a>/gis, '');

  return result;
}

const channel = {
  ...(channelInfo || {}),
  posts: [post],
  seo: {
    title: postTitle,
    text: post.content?.replace(/<[^>]*>/g, '').substring(0, 160) || postTitle
  },
}

const staticProxy = getEnv(import.meta.env, Astro, 'STATIC_PROXY') ?? '/static/'
const datetime = dayjs(post.datetime).tz(timezone)
const timeago = datetime.isBefore(dayjs().subtract(1, 'w')) ? datetime.format('HH:mm Â· ll Â· ddd') : datetime.fromNow()
---

<Layout channel={channel}>
  <!-- é¢åŒ…å±‘å¯¼èˆª -->
  <nav class="breadcrumb-nav nb-box fade-in-up">
    <a href={SITE_URL} class="breadcrumb-link btn btn-glitch">
      <i class="ri-home-line" style="margin-right: 8px;"></i>
      é¦–é¡µ
    </a>
    {showMiddleBreadcrumb && (
      <>
        <span class="breadcrumb-separator">/</span>
        <a href={sourcePage} class="breadcrumb-link btn btn-glitch">{sourceText}</a>
      </>
    )}
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">æ–‡ç« è¯¦æƒ…</span>
  </nav>

  <!-- æ–‡ç« è¯¦æƒ…å’Œå†…å®¹ -->
  <article class="post-article nb-box fade-in-up">
    <div class="section-header">
      <h1 class="section-title">
        <i class="ri-file-text-line" style="color: var(--accent-color); margin-right: 8px;"></i>
        æ–‡ç« è¯¦æƒ…
      </h1>
      <div style="flex-grow: 1; border-bottom: 1px dashed var(--fg-color);"></div>
    </div>
    <h1 class="post-title">{postTitle}</h1>
    <div class="post-meta">
      <div class="meta-item">
        <i class="ri-calendar-line" style="color: var(--accent-color); margin-right: 8px;"></i>
        <time datetime={post.datetime} class="post-date">
          {datetime.format('YYYYå¹´MMæœˆDDæ—¥')}
        </time>
      </div>
      <div class="meta-item">
        <i class="ri-time-line" style="color: var(--accent-color); margin-right: 8px;"></i>
        <span class="post-time">{datetime.format('HH:mm')}</span>
      </div>
      {
        postTags && postTags.length > 0 && (
          <div class="meta-item">
            <i class="ri-price-tag-3-line" style="color: var(--accent-color); margin-right: 8px;"></i>
            <div class="post-tags">
              {postTags.map((tag) => (
                <a href={`/search/${tag}`} class="tag btn btn-glitch">
                  #{tag}
                </a>
              ))}
            </div>
          </div>
        )
      }
    </div>
    <div class="post-content" set:html={processLinks(processedContent)} />
  </article>

  <!-- è¯„è®ºåŒºåŸŸ -->
  {
    COMMENTS && (
      <section class="comments-section nb-box">
        <div class="section-header">
          <h2 class="section-title">
            <i class="ri-chat-3-line" style="color: var(--accent-color); margin-right: 8px;"></i>
            è¯„è®ºåŒº
          </h2>
          <div style="flex-grow: 1; border-bottom: 1px dashed var(--fg-color);"></div>
        </div>
        <div class="comments-container nb-box">
          <script
            is:inline
            async
            src="https://telegram.org/js/telegram-widget.js"
            data-telegram-discussion={`catismchannel/${post.id}`}
            data-comments-limit="50"
            data-colorful="1"
            data-color="000000"
          />
        </div>
      </section>
    )
  }

  <!-- è¿”å›æŒ‰é’® -->
  <div class="post-footer nb-box">
    <a href={sourcePage} class="btn btn-primary back-button">
      <i class="ri-arrow-left-line" style="margin-right: 8px;"></i>
      è¿”å›{sourceText}
    </a>
  </div>
</Layout>

<style>
  .breadcrumb-nav {
    padding: 20px 40px;
    margin: 20px auto;
    border: var(--border-width) solid var(--fg-color);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
  }

  .breadcrumb-nav:hover {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
    transition: 0.2s ease;
  }

  .breadcrumb-link {
    color: var(--secondary-color);
    text-decoration: none;
    border-bottom: none;
  }

  .breadcrumb-current {
    color: var(--fg-color);
    font-weight: bold;
    font-family: var(--font-sans);
    text-transform: uppercase;
  }

  .breadcrumb-separator {
    color: var(--secondary-color);
    font-weight: bold;
  }

  .section-header {
    display: flex;
    align-items: center;
    border-bottom: var(--border-width) solid var(--fg-color);
    padding-bottom: 10px;
    margin-bottom: 20px;
  }

  .section-title {
    font-size: 18px;
    font-weight: 900;
    margin-bottom: 0;
    font-family: var(--font-sans);
    text-transform: uppercase;
    background: var(--fg-color);
    color: var(--bg-color);
    padding: 5px 15px;
    margin-right: 15px;
  }

  .post-article {
    max-width: 800px;
    margin: 0 auto 40px auto;
    padding: 40px;
    border: var(--border-width) solid var(--fg-color);
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
  }

  .post-article:hover {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
    transition: 0.2s ease;
  }

  .post-title {
    font-size: 32px;
    font-weight: 900;
    margin: 0 0 24px 0;
    letter-spacing: -0.02em;
    line-height: 1.2;
    font-family: var(--font-sans);
    text-transform: uppercase;
  }

  .post-meta {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 32px;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: var(--font-mono);
    text-transform: uppercase;
    font-weight: bold;
  }

  .post-date,
  .post-time {
    font-size: 14px;
    color: var(--secondary-color);
    font-weight: 500;
  }

  .post-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .tag {
    font-size: 12px;
    color: var(--secondary-color);
    border: var(--border-width) solid var(--fg-color);
    padding: 4px 12px;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
    font-family: var(--font-mono);
  }

  .tag:hover {
    color: var(--bg-color);
    background-color: var(--accent-color);
    border-color: var(--accent-color);
    animation: glitch-anim 0.3s cubic-bezier(.25, .46, .45, .94) both infinite;
  }

  .post-content {
    font-size: 16px;
    line-height: 1.7;
    color: var(--fg-color);
    font-family: var(--font-mono);
  }

  .post-content :global(h1),
  .post-content :global(h2),
  .post-content :global(h3),
  .post-content :global(h4),
  .post-content :global(h5),
  .post-content :global(h6) {
    margin-top: 32px;
    margin-bottom: 20px;
    font-weight: 900;
    letter-spacing: -0.01em;
    font-family: var(--font-sans);
    text-transform: uppercase;
  }

  .post-content :global(h1) {
    font-size: 24px;
  }
  .post-content :global(h2) {
    font-size: 20px;
  }
  .post-content :global(h3) {
    font-size: 18px;
  }
  .post-content :global(h4) {
    font-size: 16px;
  }
  .post-content :global(h5) {
    font-size: 15px;
  }
  .post-content :global(h6) {
    font-size: 14px;
  }

  .post-content :global(p) {
    margin-bottom: 20px;
  }

  .post-content :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: var(--box-border-radius);
    border: var(--border-width) solid var(--fg-color);
    margin: 24px 0;
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
    transition: all 0.3s ease;
  }

  .post-content :global(img:hover) {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
  }

  .post-content :global(a) {
    color: var(--fg-color);
    border-bottom: var(--border-width) solid var(--border-color);
    transition: border-color 0.2s ease;
  }

  .post-content :global(a:hover) {
    border-bottom-color: var(--accent-color);
  }

  .post-content :global(blockquote) {
    margin: 24px 0;
    padding: 20px;
    border-left: var(--border-width) solid var(--fg-color);
    background-color: var(--code-background-color);
    font-style: italic;
    color: var(--secondary-color);
    font-family: var(--font-mono);
    border: var(--border-width) solid var(--fg-color);
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
  }

  .post-content :global(blockquote:hover) {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
    transition: 0.2s ease;
  }

  .post-content :global(pre) {
    background-color: var(--code-background-color);
    border: var(--border-width) solid var(--fg-color);
    border-radius: var(--box-border-radius);
    padding: 20px;
    overflow-x: auto;
    margin: 24px 0;
    font-size: 14px;
    font-family: var(--font-mono);
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
  }

  .post-content :global(pre:hover) {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
    transition: 0.2s ease;
  }

  .post-content :global(code) {
    background-color: var(--code-background-color);
    padding: 2px 4px;
    border-radius: 2px;
    font-size: 0.9em;
    border: var(--border-width) solid var(--fg-color);
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin-bottom: 20px;
    padding-left: 24px;
  }

  .post-content :global(li) {
    margin-bottom: 8px;
  }

  .comments-section {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px;
    border: var(--border-width) solid var(--fg-color);
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
  }

  .comments-section:hover {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
    transition: 0.2s ease;
  }

  .comments-title {
    font-size: 24px;
    font-weight: 900;
    margin-bottom: 24px;
    letter-spacing: -0.02em;
    font-family: var(--font-sans);
    text-transform: uppercase;
  }

  .comments-container {
    border: var(--border-width) solid var(--fg-color);
    border-radius: var(--box-border-radius);
    padding: 24px;
    background-color: var(--code-background-color);
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
  }

  .comments-container:hover {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
    transition: 0.2s ease;
  }

  .post-footer {
    text-align: center;
    padding: 40px;
    border-top: var(--border-width) solid var(--fg-color);
    margin-top: 60px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
  }

  .post-footer:hover {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
    transition: 0.2s ease;
  }

  .back-button {
    display: inline-block;
    padding: 12px 24px;
    background-color: var(--bg-color);
    color: var(--fg-color);
    border: var(--border-width) solid var(--fg-color);
    border-radius: var(--box-border-radius);
    text-decoration: none;
    font-size: 14px;
    font-weight: bold;
    font-family: var(--font-mono);
    text-transform: uppercase;
    transition: all 0.2s ease;
  }

  .back-button:hover {
    background-color: var(--bg-color); /* ä¿æŒç™½è‰²èƒŒæ™¯ */
    color: var(--accent-color); /* æ©™è‰²æ–‡å­— */
    border-color: var(--accent-color); /* æ©™è‰²è¾¹æ¡† */
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
  }

  .back-button:active {
    transform: translate(var(--shadow-distance), var(--shadow-distance));
    box-shadow: 0 0 0 var(--fg-color);
    color: var(--accent-color); /* ç¡®ä¿activeçŠ¶æ€æ—¶æ–‡å­—å¯è§ */
    background-color: var(--bg-color); /* ä¿æŒç™½è‰²èƒŒæ™¯ */
  }

  /* Link Preview Styles - Enhanced */
  .post-content :global(.link-preview-card) {
    display: flex;
    flex-direction: column;
    gap: 8px;
    border: var(--border-width) solid var(--fg-color);
    border-radius: var(--box-border-radius);
    padding: 16px;
    margin: 16px 0;
    background-color: var(--code-background-color);
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
    text-align: left;
    box-shadow: var(--shadow-distance) var(--shadow-distance) 0 var(--fg-color);
  }

  .post-content :global(.link-preview-card:hover) {
    transform: translate(-2px, -2px);
    box-shadow: calc(var(--shadow-distance) + 2px) calc(var(--shadow-distance) + 2px) 0 var(--accent-color);
    border-color: var(--accent-color);
  }

  .post-content :global(.link-preview-header) {
    display: flex;
    align-items: center;
    gap: 12px;
    justify-content: flex-start;
  }

  .post-content :global(.link-preview-icon) {
    width: 24px;
    height: 24px;
    border-radius: 0px;
    background-color: transparent;
    color: var(--fg-color);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
    flex-shrink: 0;
    border: var(--border-width) solid var(--fg-color);
  }

  .post-content :global(.link-preview-title) {
    font-weight: 600;
    font-size: 16px;
    line-height: 1.4;
    color: var(--fg-color);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
    font-family: var(--font-sans);
    text-transform: uppercase;
  }

  .post-content :global(.link-preview-domain) {
    font-size: 14px;
    color: var(--secondary-color);
    display: flex;
    align-items: center;
    gap: 4px;
    padding-left: 0;
    text-align: left;
    font-family: var(--font-mono);
  }

  .post-content :global(.link-preview-domain::before) {
    content: 'ğŸ”—';
    font-size: 12px;
  }

  @media (max-width: 768px) {
    .breadcrumb-nav,
    .post-article,
    .comments-section,
    .post-footer {
      padding: 20px;
    }

    .post-title {
      font-size: 28px;
    }

    .post-meta {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }

    .post-content {
      font-size: 15px;
    }

    .section-title {
      font-size: 16px;
    }
  }
</style>
